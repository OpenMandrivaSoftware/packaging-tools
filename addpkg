#!/bin/sh
# Add a (previously created) package to OpenMandriva

if [ "$(ls -1 *.spec 2>/dev/null |wc -l)" != "1" ]; then
	echo "Run $0 from a directory containing a spec file"
	echo "(e.g. what was generated by vs)"
	exit 1
fi
TREE=main
if [ -n "$1" ]; then
	case "$1" in
	main|unsupported|restricted|non-free)
		TREE="$1"
		;;
	*)
		echo "Please add to an existing tree"
		exit 1 
		;;
	esac
fi


SPEC=$(ls *.spec)
NAME=$(basename $SPEC .spec)
SUMMARY=$(cat *.spec |grep -i ^Summary: |head -n1 |cut -d: -f2- |xargs echo)

echo "Creating $NAME package: $SUMMARY"

if ! [ -e .git ]; then
	git init
	ls *.tar* &>/dev/null && abb store *.tar*
	ls *.tbz* &>/dev/null && abb store *.tbz*
	ls *.tgz* &>/dev/null && abb store *.tgz*
	ls *.txz* &>/dev/null && abb store *.txz*
	ls *.zip &>/dev/null && abb store *.zip
	ls *.7z &>/dev/null && abb store *.7z
	ls *.crate &>/dev/null && abb store *.crate
	ls *.jar &>/dev/null && abb store *.jar
	git add *.spec
	git add .abf.yml &>/dev/null || :
	git add *.txt &>/dev/null || :
	git add *.patch &>/dev/null || :
	git add *.diff &>/dev/null || :
	git add *.sh &>/dev/null || :
	git add *.csh &>/dev/null || :
	git add *-completion &>/dev/null || :
	git add *.md &>/dev/null || :
	git add *.json &>/dev/null || :
	git add *.rpmlintrc &>/dev/null || :
	git commit -am "Initial package"
fi

gh repo create --description "$SUMMARY" --public --push --source . OpenMandrivaAssociation/$NAME
abf create_empty --description "$SUMMARY" --visibility public -v $NAME openmandriva
abf add -p openmandriva/$NAME cooker/$TREE
abf add -p openmandriva/$NAME rolling/$TREE
#abf build -a aarch64 -a znver1 -a x86_64 -b master --auto-publish-status default --skip-personal --update-type enhancement -p openmandriva/$NAME
abf chain_build -a aarch64 -a znver1 -a x86_64 -b master --update-type enhancement --auto-publish-status=default openmandriva/$NAME
