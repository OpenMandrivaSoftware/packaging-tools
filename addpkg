#!/bin/sh
# Add a (previously created) package to OpenMandriva

if [ "$(ls -1 *.spec 2>/dev/null |wc -l)" != "1" ]; then
	echo "Run $0 from a directory containing a spec file"
	echo "(e.g. what was generated by vs)"
	exit 1
fi
TREE=main
if [ -n "$1" ]; then
	case "$1" in
	main|unsupported|restricted|non-free)
		TREE="$1"
		;;
	*)
		echo "Please add to an existing tree"
		exit 1 
		;;
	esac
fi


SPEC=$(ls *.spec)
NAME=$(basename $SPEC .spec)
SUMMARY=$(cat *.spec |grep -i ^Summary: |cut -d: -f2- |xargs echo)

echo "Creating $NAME package: $SUMMARY"

git init
abb store *.tar*
git add .abf.yml *.spec
git add *.patch &>/dev/null || :
git add *.diff &>/dev/null || :
git commit -am "Initial package"

gh repo create --description "$SUMMARY" --public --push --source . OpenMandrivaAssociation/$NAME
abf create_empty --description "$SUMMARY" --visibility public -v $NAME openmandriva
abf add -p openmandriva/$NAME cooker/$TREE
abf add -p openmandriva/$NAME rolling/$TREE
abf build -a aarch64 -a znver1 -a x86_64 -b master --auto-publish-status default --skip-personal --update-type enhancement -p openmandriva/$NAME
